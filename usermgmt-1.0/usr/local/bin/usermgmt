#!/bin/bash

# =========================
# Enhanced User Management Tool v2.0
# =========================

# Color definitions
readonly RED="\e[31m"
readonly GREEN="\e[32m"
readonly YELLOW="\e[33m"
readonly BLUE="\e[34m"
readonly CYAN="\e[36m"
readonly PURPLE="\e[35m"
readonly RESET="\e[0m"

# Global variables
readonly SCRIPT_NAME="User Management Tool v2.0"
readonly LOG_FILE="/var/log/user_manager.log"

# =========================
# Utility Functions
# =========================

log_message() {
    local level="$1"
    local message="$2"
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $message" | tee -a "$LOG_FILE"
}

print_banner() {
    clear
    echo -e "${CYAN}"
    cat << 'EOF'
.__  __                .__    .__           .___
|__|/  |______    ____ |  |__ |__|__  ___ __| _/_______  __
|  \   __\__  \ _/ ___\|  |  \|  \  \/  // __ |/ __ \  \/ /
|  ||  |  / __ \\  \___|   Y  \  |>    </ /_/ \  ___/\   /
|__||__| (____  /\___  >___|  /__/__/\_ \____ |\___  >\_/
              \/     \/     \/         \/    \/    \/
EOF
    echo -e "${YELLOW}                 itachiXDev${RESET}"
    echo -e "${PURPLE}                 Enhanced v2.0${RESET}"
    echo
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}This script must be run as root (sudo)!${RESET}"
        exit 1
    fi
}

check_user_exists() {
    local username="$1"
    id "$username" &>/dev/null
}

get_user_status() {
    local user="$1"
    local status=""

    if ! check_user_exists "$user"; then
        status="âŒ Not exists"
    elif sudo passwd -S "$user" | grep -q " L "; then
        status="ğŸ”’ Locked"
    else
        status="âœ… Active"
    fi
    echo "$status"
}

generate_secure_password() {
    local length=16
    openssl rand -base64 48 | tr -d "=+/" | cut -c1-"$length"
}

# =========================
# User Operations
# =========================

add_user() {
    read -p "Enter username: " user
    [[ -z "$user" ]] && { echo -e "${RED}Username cannot be empty!${RESET}"; return 1; }

    if check_user_exists "$user"; then
        echo -e "${RED}User '$user' already exists!${RESET}"
        return 1
    fi

    read -p "Use auto-generated password? (y/n): " auto_pass
    if [[ "$auto_pass" =~ ^[Yy]$ ]]; then
        local pass=$(generate_secure_password)
        echo -e "${GREEN}Generated password: $pass${RESET}"
    else
        read -s -p "Enter password: " pass
        echo
        read -s -p "Confirm password: " pass2
        echo
        [[ "$pass" != "$pass2" ]] && { echo -e "${RED}Passwords don't match!${RESET}"; return 1; }
    fi

    sudo useradd -m -s /bin/bash "$user"
    echo "$user:$pass" | sudo chpasswd
    sudo usermod -aG sudo "$user"  # Optional: add to sudo group

    log_message "INFO" "User '$user' created successfully"
    echo -e "${GREEN}âœ“ User '$user' created with home directory!${RESET}"
}

delete_user() {
    read -p "Enter username to delete: " user

    if ! check_user_exists "$user"; then
        echo -e "${RED}User '$user' not found!${RESET}"
        return 1
    fi

    read -p "Delete user '$user' and home directory? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        sudo userdel -r "$user"
        log_message "INFO" "User '$user' deleted with home directory"
        echo -e "${GREEN}âœ“ User '$user' deleted completely!${RESET}"
    else
        sudo userdel "$user"
        log_message "INFO" "User '$user' deleted (home preserved)"
        echo -e "${GREEN}âœ“ User '$user' deleted!${RESET}"
    fi
}

display_user_info() {
    read -p "Enter username: " user

    if ! check_user_exists "$user"; then
        echo -e "${RED}User '$user' not found!${RESET}"
        return 1
    fi

    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BLUE}â•‘${RESET} ${CYAN}User Information for: $user${RESET}${BLUE} $(printf '%*s' $((35-${#user})) '' )â•‘${RESET}"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "Username" "$user"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "UID" "$(id -u "$user")"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "GID" "$(id -g "$user")"
    printf "${BLUE}â•‘${RESET} %-15s: ${RESET}%-22s ${BLUE}â•‘${RESET}\n" "Groups" "$(id -Gn "$user" | cut -c1-22)"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "Home" "$(grep "^$user:" /etc/passwd | cut -d: -f6)"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "Shell" "$(grep "^$user:" /etc/passwd | cut -d: -f7)"
    printf "${BLUE}â•‘${RESET} %-15s: ${RESET}%-22s ${BLUE}â•‘${RESET}\n" "Status" "$(get_user_status "$user")"
    printf "${BLUE}â•‘${RESET} %-15s: %-22s ${BLUE}â•‘${RESET}\n" "Sudo Access" "$(groups "$user" | grep -qw sudo && echo 'Yes' || echo 'No')"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

list_users() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BLUE}â•‘${RESET} ${CYAN}All System Users${RESET}${BLUE}                                        â•‘${RESET}"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
    printf "${BLUE}â•‘${RESET} %-4s ${BLUE}â”‚${RESET} %-12s ${BLUE}â”‚${RESET} %-12s ${BLUE}â”‚${RESET} %-18s ${BLUE}â•‘${RESET}\n" "UID" "Username" "Status" "Home Dir"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"

    while IFS=: read -r user pass uid gid gecos home shell; do
        if [[ "$home" =~ ^/home/ ]] || [[ "$uid" -ge 1000 ]]; then
            local status=$(get_user_status "$user")
            printf "${BLUE}â•‘${RESET} %-4s ${BLUE}â”‚${RESET} %-12s ${BLUE}â”‚${RESET} %-12s ${BLUE}â”‚${RESET} %-18s ${BLUE}â•‘${RESET}\n" \
                "$uid" "$user" "$status" "${home:0:18}"
        fi
    done < /etc/passwd

    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
}

# =========================
# Main Menu
# =========================

show_menu() {
    print_banner
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${YELLOW}1.${RESET} â• ${GREEN}Add User${RESET}"
    echo -e "${YELLOW}2.${RESET} â– ${RED}Delete User${RESET}"
    echo -e "${YELLOW}3.${RESET} ğŸ”‘ ${GREEN}Change Password${RESET}"
    echo -e "${YELLOW}4.${RESET} ğŸ”’ ${RED}Lock User${RESET}"
    echo -e "${YELLOW}5.${RESET} ğŸ”“ ${GREEN}Unlock User${RESET}"
    echo -e "${YELLOW}6.${RESET} â„¹ï¸  ${BLUE}User Info${RESET}"
    echo -e "${YELLOW}7.${RESET} ğŸ‘¥ ${CYAN}List All Users${RESET}"
    echo -e "${YELLOW}8.${RESET} âš¡ ${PURPLE}Grant Sudo Access${RESET}"
    echo -e "${YELLOW}9.${RESET} ğŸ“Š ${YELLOW}Show Logs${RESET}"
    echo -e "${YELLOW}0.${RESET} âŒ ${RED}Exit${RESET}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo
}

handle_choice() {
    case $1 in
        1) add_user ;;
        2) delete_user ;;
        3)
            read -p "Username: " user
            if check_user_exists "$user"; then
                sudo passwd "$user"
                log_message "INFO" "Password changed for user '$user'"
                echo -e "${GREEN}âœ“ Password changed!${RESET}"
            else
                echo -e "${RED}User not found!${RESET}"
            fi
            ;;
        4)
            read -p "Username: " user
            if check_user_exists "$user"; then
                sudo usermod -L "$user"
                log_message "INFO" "User '$user' locked"
                echo -e "${GREEN}âœ“ User locked!${RESET}"
            else
                echo -e "${RED}User not found!${RESET}"
            fi
            ;;
        5)
            read -p "Username: " user
            if check_user_exists "$user"; then
                sudo usermod -U "$user"
                log_message "INFO" "User '$user' unlocked"
                echo -e "${GREEN}âœ“ User unlocked!${RESET}"
            else
                echo -e "${RED}User not found!${RESET}"
            fi
            ;;
        6) display_user_info ;;
        7) list_users ;;
        8)
            read -p "Username: " user
            if check_user_exists "$user"; then
                sudo usermod -aG sudo "$user"
                log_message "INFO" "Sudo access granted to '$user'"
                echo -e "${GREEN}âœ“ Sudo access granted!${RESET}"
            else
                echo -e "${RED}User not found!${RESET}"
            fi
            ;;
        9)
            echo -e "${BLUE}=== Recent Log Activity (tail -20) ===${RESET}"
            tail -20 "$LOG_FILE" | while IFS= read -r line; do
                echo "$line"
            done
            ;;
        0)
            echo -e "${GREEN}ğŸ‘‹ Thanks for using $SCRIPT_NAME!${RESET}"
            log_message "INFO" "Script exited"
            exit 0
            ;;
        *) echo -e "${RED}âŒ Invalid choice!${RESET}" ;;
    esac
}

# =========================
# Main Execution
# =========================

main() {
    check_root
    touch "$LOG_FILE" && chmod 644 "$LOG_FILE"
    log_message "INFO" "User Management Tool started"

    while true; do
        show_menu
        read -p "Enter choice (0-9): " choice
        echo
        handle_choice "$choice"
        echo -e "${YELLOW}Press Enter to continue...${RESET}"
        read
    done
}

main "$@"
